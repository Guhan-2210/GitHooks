name: Cloudflare Deployment

on:
  workflow_run:
    workflows: ["PR Quality Checks"]
    types: [completed]
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to deploy (preview or production)"
        required: true
        type: choice
        options:
          - preview
          - production
      deployment_id:
        description: "Cloudflare Deployment Version ID to rollback to"
        required: true
        type: string

# Shared environment variables for all jobs
env:
  NODE_VERSION: 20
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  PREVIEW_URL: ${{ secrets.PREVIEW_URL }}  # e.g., https://todo-list-api-preview.your-subdomain.workers.dev
  PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}  # e.g., https://todo-list-api-production.your-subdomain.workers.dev
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

jobs:
  # ======================================================
  # üü° 1. PREVIEW DEPLOYMENT (Automatic for PRs)
  # ======================================================
  deploy-preview:
    name: Deploy Preview (PR)
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.event == 'pull_request' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Get Previous Deployment Version
        id: prev_version
        run: |
          echo "Getting previous deployment version..."
          PREV_VERSION=$(npx wrangler deployments list --env preview 2>/dev/null | grep -v "Version ID" | head -1 | awk '{print $1}' || echo "none")
          echo "previous_version=$PREV_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREV_VERSION"

      - name: Publish to Cloudflare (Preview)
        id: deploy
        run: |
          echo "üöÄ Deploying to preview environment..."
          npx wrangler deploy --env preview

      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to propagate..."
          sleep 30

      - name: Health Check
        id: health_check
        run: |
          echo "üè• Running health check on ${{ env.PREVIEW_URL }}/health"
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PREVIEW_URL }}/health || echo "000")
          echo "Health check status: $HEALTH_STATUS"
          
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Health check passed!"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Health check failed with status: $HEALTH_STATUS"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Rollback on Health Check Failure
        if: failure() && steps.health_check.outcome == 'failure' && steps.prev_version.outputs.previous_version != 'none'
        run: |
          echo "üîÑ Health check failed! Rolling back to previous version..."
          echo "Previous version: ${{ steps.prev_version.outputs.previous_version }}"
          npx wrangler rollback --env preview --version-id ${{ steps.prev_version.outputs.previous_version }}
          echo "‚úÖ Rollback completed!"

      - name: Notify Slack on Rollback
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          curl -X POST ${{ env.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "üö® Automatic Rollback Triggered",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üö® Deployment Rollback - Preview Environment"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nPreview"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Reason:*\nHealth check failed"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.event.workflow_run.head_branch }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Rolled back to:*\n${{ steps.prev_version.outputs.previous_version }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "View workflow run: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here>"
                }
              }
            ]
          }'

  # ======================================================
  # üîµ 2. PRODUCTION DEPLOYMENT (Automatic for main merges)
  # ======================================================
  deploy-production:
    name: Deploy Production (Main)
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_run' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'main' &&
      github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Get Previous Deployment Version
        id: prev_version
        run: |
          echo "Getting previous deployment version..."
          PREV_VERSION=$(npx wrangler deployments list --env production 2>/dev/null | grep -v "Version ID" | head -1 | awk '{print $1}' || echo "none")
          echo "previous_version=$PREV_VERSION" >> $GITHUB_OUTPUT
          echo "Previous version: $PREV_VERSION"

      - name: Publish to Cloudflare (Production)
        id: deploy
        run: |
          echo "üöÄ Deploying to production environment..."
          npx wrangler deploy --env production

      - name: Wait for Deployment
        run: |
          echo "‚è≥ Waiting 30 seconds for deployment to propagate..."
          sleep 30

      - name: Health Check
        id: health_check
        run: |
          echo "üè• Running health check on ${{ env.PRODUCTION_URL }}/health"
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" ${{ env.PRODUCTION_URL }}/health || echo "000")
          echo "Health check status: $HEALTH_STATUS"
          
          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Health check passed!"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Health check failed with status: $HEALTH_STATUS"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Rollback on Health Check Failure
        if: failure() && steps.health_check.outcome == 'failure' && steps.prev_version.outputs.previous_version != 'none'
        run: |
          echo "üîÑ Health check failed! Rolling back to previous version..."
          echo "Previous version: ${{ steps.prev_version.outputs.previous_version }}"
          npx wrangler rollback --env production --version-id ${{ steps.prev_version.outputs.previous_version }}
          echo "‚úÖ Rollback completed!"

      - name: Notify Slack on Rollback
        if: failure() && steps.health_check.outcome == 'failure'
        run: |
          curl -X POST ${{ env.SLACK_WEBHOOK_URL }} \
          -H 'Content-Type: application/json' \
          -d '{
            "text": "üö® Automatic Rollback Triggered",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "üö® Deployment Rollback - Production Environment"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Environment:*\nProduction"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Reason:*\nHealth check failed"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\nmain"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Rolled back to:*\n${{ steps.prev_version.outputs.previous_version }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "View workflow run: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Click here>"
                }
              }
            ]
          }'

  # ======================================================
  # üîÅ 3. MANUAL ROLLBACK (Preview & Production)
  # ======================================================
  rollback:
    name: Manual Rollback Deploy
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: List Recent Deployments
        run: |
          echo "üìã Recent deployments for ${{ github.event.inputs.env }}:"
          npx wrangler deployments list --env ${{ github.event.inputs.env }} || echo "Unable to list deployments"

      - name: Rollback to Specific Version
        run: |
          echo "üîÑ Rolling back ${{ github.event.inputs.env }} to deployment version:"
          echo "üì¶ Deployment ID: ${{ github.event.inputs.deployment_id }}"
          npx wrangler rollback --env ${{ github.event.inputs.env }} --version-id ${{ github.event.inputs.deployment_id }}
          echo "‚úÖ Rollback completed successfully!"
