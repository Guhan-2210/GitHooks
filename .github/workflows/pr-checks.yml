name: PR Quality Checks

# Self-hosted CI/CD workflow with dependency caching and artifact uploads
# Updated: Removed node_modules artifacts, using cache only for faster execution

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # -------------------------------
  # JOB 1: INSTALL DEPENDENCIES
  # -------------------------------
  install-dependencies:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          # Enable caching for npm dependencies
          cache: 'npm'


      - name: Install dependencies
        run: npm ci

      # Cache node_modules for next job
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-


  # -------------------------------
  # JOB 2: QUALITY CHECKS
  # Depends on install-dependencies job
  # -------------------------------
  quality-checks:
    runs-on: self-hosted
    # Job dependency: wait for install-dependencies to complete
    needs: install-dependencies

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # Restore cached node_modules from previous job
      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      # -------------------------------
      # ESLINT
      # -------------------------------
      - name: Run ESLint
        run: npm run lint
        # example package.json script:
        # "lint": "eslint ."

      # -------------------------------
      # PRETTIER
      # -------------------------------
      - name: Run Prettier check
        run: npm run format:check
        # example script:
        # "format:check": "prettier --check ."

      # -------------------------------
      # KNIP (NORMAL MODE, NOT STRICT)
      # -------------------------------
      - name: Run Knip
        run: npm run knip
        # example script:
        # "knip": "knip"

      # -------------------------------
      # UNIT TESTS
      # -------------------------------
      - name: Run Tests
        run: npm test

      # -------------------------------
      # CODE COVERAGE
      # -------------------------------
      - name: Run Tests with Coverage
        run: npm run test:coverage
        env:
          # Using a secret (example)
          NODE_ENV: ${{ secrets.NODE_ENV || 'test' }}

      # Upload test results as artifact
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            coverage/
            **/*.test.log
          retention-days: 30

      # Upload coverage report as artifact
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30
