name: PR Quality Checks

# Self-hosted CI/CD workflow with dependency caching and artifact uploads
# Updated: Removed node_modules artifacts, using cache only for faster execution

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  # -------------------------------
  # JOB 1: INSTALL DEPENDENCIES
  # -------------------------------
  install-dependencies:
    runs-on: self-hosted
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------
      # PRINT WORKFLOW INFORMATION
      # -------------------------------
      - name: Print Workflow Info
        run: |
          echo "=========================================="
          echo "üöÄ WORKFLOW INFORMATION"
          echo "=========================================="
          echo "Runner Name: ${{ runner.name }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "Runner Architecture: ${{ runner.arch }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Working Directory: $(pwd)"
          echo "Directory Contents:"
          ls -la
          echo "=========================================="
          echo "üîê SECRETS STATUS"
          echo "=========================================="
          echo "NODE_ENV Secret: ${{ secrets.NODE_ENV != '' && '‚úÖ Set' || '‚ùå Not Set' }}"
          echo "MY_SECRET Secret: ${{ secrets.MY_SECRET != '' && '‚úÖ Set' || '‚ùå Not Set' }}"
          echo "CODECOV_TOKEN Secret: ${{ secrets.CODECOV_TOKEN != '' && '‚úÖ Set' || '‚ùå Not Set' }}"
          echo "=========================================="

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          # Enable caching for npm dependencies
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Cache node_modules for next job
      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-


  # -------------------------------
  # JOB 2: QUALITY CHECKS
  # Depends on install-dependencies job
  # -------------------------------
  quality-checks:
    runs-on: self-hosted
    # Job dependency: wait for install-dependencies to complete
    needs: install-dependencies
    
    # Set environment variables from secrets
    env:
      NODE_ENV: ${{ secrets.NODE_ENV || 'test' }}
      MY_SECRET: ${{ secrets.MY_SECRET }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------------------------------
      # PRINT JOB INFORMATION
      # -------------------------------
      - name: Print Quality Check Job Info
        run: |
          echo "=========================================="
          echo "üß™ QUALITY CHECKS JOB"
          echo "=========================================="
          echo "Job ID: ${{ github.job }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Attempt: ${{ github.run_attempt }}"
          echo "Working Directory: $(pwd)"
          echo "=========================================="
          echo "üîê ENVIRONMENT VARIABLES (from secrets)"
          echo "=========================================="
          echo "NODE_ENV: $NODE_ENV"
          echo "MY_SECRET: ${MY_SECRET:+***REDACTED***}"
          echo "MY_SECRET Length: ${#MY_SECRET}"
          echo "=========================================="

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # Restore cached node_modules from previous job
      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      # -------------------------------
      # ESLINT
      # -------------------------------
      - name: Run ESLint
        run: npm run lint

      # -------------------------------
      # PRETTIER
      # -------------------------------
      - name: Run Prettier check
        run: npm run format:check

      # -------------------------------
      # KNIP (NORMAL MODE, NOT STRICT)
      # -------------------------------
      - name: Run Knip
        run: npm run knip

      # -------------------------------
      # UNIT TESTS
      # -------------------------------
      - name: Run Tests
        run: npm test

      # -------------------------------
      # CODE COVERAGE
      # -------------------------------
      - name: Run Tests with Coverage
        run: npm run test:coverage
        env:
          # Pass additional environment variables for testing
          CI: true
          GITHUB_ACTIONS: true

      # -------------------------------
      # PRINT COVERAGE SUMMARY
      # -------------------------------
      - name: Print Coverage Summary
        if: always()
        run: |
          echo "=========================================="
          echo "üìä COVERAGE SUMMARY"
          echo "=========================================="
          if [ -f coverage/lcov.info ]; then
            echo "‚úÖ Coverage report generated successfully"
            echo "Coverage files:"
            ls -lh coverage/ | head -10
          else
            echo "‚ùå No coverage report found"
          fi
          echo "=========================================="

      # Upload test results as artifact
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_number }}
          path: |
            coverage/
            **/*.test.log
          retention-days: 30

      # Upload coverage report as artifact
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-${{ github.run_number }}
          path: coverage/
          retention-days: 30
      
      # -------------------------------
      # FINAL STATUS
      # -------------------------------
      - name: Print Final Status
        if: always()
        run: |
          echo "=========================================="
          echo "‚úÖ QUALITY CHECKS COMPLETED"
          echo "=========================================="
          echo "Workflow Status: ${{ job.status }}"
          echo "Time: $(date)"
          echo "Artifacts uploaded successfully!"
          echo "=========================================="
